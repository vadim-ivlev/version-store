
<!-- <img src="images/title1.gif"> -->

version-store
========


хранение версий документов RG.RU в Elasticsearch

-------------------------------

## Предпосылки

Когда редактируется какой-нибудь документ, текст время от времени 
автоматически сохраняется в базу данных. Однако, если редактор по ошибке что-то изменил в тексте,
и эти изменения успели сохраниться, то возможности вернуться к предыдущей версии нет.

Сервис хранения версий документов и возврата к любой из них, наподобие того 
как это реализовано в Google Docs, был бы очень полезным. 
Пользовательский-интерфейс может выглядеть, как показано на рисунке.

<img src=images/ui.jpg style="max-width:500px; border: 1px solid silver; margin-bottom: 10px;">

## Схема приложения

В качестве хранилища версий был выбран Elasticsearch.


API сервиса должен включать возможности 1) показа списка сохранённых версий, 2) извлечения отдельной версии документа, и 3) сохранения новой версии.





## Безопасность

**API** сервиса доступен только пользователям авторизованным в **auth-proxy**.

Далее по тексту ссылки и примеры кода являются рабочими. Чтобы они срабатывали вам необходимо  авторизоваться в

<https://auth-admin.now.sh/?url=https://auth-proxy.rg.ru>


## Структура документа

Сохраняемый документ может иметь любую структуру и должен быть представлен в JSON формате.
Версия документа однозначно определяется значением следующих полей 

- **type** : string - тип документа
- **id** : int64 - идентификатор документа
- **version_time** : timestamp - штамп времени создания версии. 
  Может быть в строковом формате, например `"2019-09-08T12:39:01.03"`, или в числовом
  как время в миллисекундах с начала эпохи, например `1594286004006`

Эти поля являются обязательными при сохранении версии документа.
    
## API Доступа к версиям документов

Ссылки рабочие, можно щелкать, при условии, что вы авторизовались в 
<a target="_blank" href="https://auth-admin.now.sh/?url=https://auth-proxy.rg.ru">auth-proxy</a>

**Конечная точка** доступа к версиям документов

- **ENDPOINT** = https://auth-proxy.rg.ru/apps/version-store/doc_versions

**Получение списка версий**

Получить список версий документа типа `info` с идентификатором `1`

- ENDPOINT [/_search?pretty&q=(type:info)AND(id:1)](https://auth-proxy.rg.ru/apps/version-store/doc_versions/_search?pretty&q=(type:info)AND(id:1))

Получить список версий документа типа `material` с идентификатором `4899`

- ENDPOINT [/_search?pretty&q=(type:material)AND(id:4899)&size=3&sort=version_time:desc](https://auth-proxy.rg.ru/apps/version-store/doc_versions/_search?pretty&q=(type:material)AND(id:4899)&size=3&sort=version_time:desc)

**Параметры запроса**:

- **pretty** - *Красиво форматирует ответ сервера, увеличивая объем данных.*
- **q**=(type:material)AND(id:4899) - *Поисковый запрос Lucene.*
- **sort**=version_time:desc - *порядок сортировки по полю version_time (asc|desc)*
- **size**=3 - *Размер выборки*
- **_source**=type,id,version_time,title,editor - *перечень полей для возврата.*
    *Полезно для уменьшения объема передаваемых данных, когда версий много 
    и размер документов велик.*

    *Например, чтобы показывать в перечне только время и автора*

  - ENDPOINT [/_search?pretty&q=(type:material)AND(id:4899)&_source=version_time,editor](https://auth-proxy.rg.ru/apps/version-store/doc_versions/_search?pretty&q=(type:material)AND(id:4899)&_source=version_time,editor)
    

**Получение заданной версии документа**

Поле `_id` каждого элемента списка версий содержит однозначный идентификатор версии документа. 
Значение этого поля можно использовать для извлечения версии документа.


- ENDPOINT [/_doc/s_mULnMB7-Vwr_C2r4CJ?pretty](https://auth-proxy.rg.ru/apps/version-store/doc_versions/_doc/s_mULnMB7-Vwr_C2r4CJ?pretty)


**Добавление версии документа**

