
<!-- <img src="images/title1.gif"> -->

version-store
========


хранение версий документов RG.RU в Elasticsearch

-------------------------------

## Предпосылки

Когда создается какой-нибудь документ, изменения в тексте время от времени 
автоматически сохраняются в базу данных. Однако, если редактор что-то случайно удалил
и эти изменения успели сохраниться, то нет возможности вернуться к предыдущей версии.

Сервис хранения версий документов и возврата к любой из них, наподобие того 
как это реализовано в Google Docs, был бы очень полезным. 
Пользовательский-интерфейс может выглядеть, как показано на рисунке.

<img src=images/ui.jpg style="max-width:600px;">

В качестве хранилища версий был выбран Elasticsearch.
API сервиса должен включать показ списка сохранённых версий документа, извлечение отдельной версии документа, и сохранения новой версии.

<!-- ## Схема приложения -->




## Безопасность

**API** сервиса доступен только пользователям авторизованным в **auth-proxy**.

Далее по тексту ссылки и примеры кода являются рабочими. Чтобы они срабатывали вам необходимо  авторизоваться в

<https://auth-admin.now.sh/?url=https://auth-proxy.rg.ru>


## Структура документа

Документ может иметь любую структуру и должен быть представлен в JSON формате.
Версия документа определяется значением полей 

- **type** : string - тип документа
- **id** : int64 - идентификатор документа
- **version_time** : timestamp - штамп времени создания версии. 
  Может быть в строковом формате, например `"2019-09-08T12:39:01.03"`, или в числовом
  как время в миллисекундах с начала эпохи, например `1233456623452`

Эти поля являются обязательными при сохранении версии документа.
    
## API Доступа к версиям документов

Конечная точка доступа к версиям документов

- ENDPOINT = https://auth-proxy.rg.ru/apps/version-store/doc_versions

**Как получить список версий документа**

Получить список версий документа типа `info` с идентификатором `1`

- ENDPOINT [/_search?pretty&q=(type:info)AND(id:1)](https://auth-proxy.rg.ru/apps/version-store/doc_versions/_search?pretty&q=(type:info)AND(id:1))

Получить список версий документа типа `material` с идентификатором `1`

- ENDPOINT [/_search?pretty&q=(type:material)AND(id:4899)&size=3&sort=version_time:desc](https://auth-proxy.rg.ru/apps/version-store/doc_versions/_search?pretty&q=(type:material)AND(id:4899)&size=3&sort=version_time:desc)

Параметры запроса:

- **pretty** - *Форматирует ответ сервера.*
- **q**=(type:material)AND(id:4899) - Поисковый запрос Lucene.
- **size**=3 - Размер выборки
- **sort**=version_time:desc - порядок сортировки по полю version_time (asc|desc)
- **_source**=type,id,version_time,title,editor - перечень полей для возврата.
    Полезно для уменьшения объема передаваемых данных, когда версий много 
    и размер документов велик.

    Например, чтобы показывать в перечне только время и автора

  - ENDPOINT [/_search?pretty&q=(type:material)AND(id:4899)&_source=version_time,editor](https://auth-proxy.rg.ru/apps/version-store/doc_versions/_search?pretty&q=(type:material)AND(id:4899)&_source=version_time,editor)
    

**Как получить необходимую версию версию документа**

**Как добавить добавить версию документа**

