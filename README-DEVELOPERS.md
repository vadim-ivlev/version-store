
version-store
========


хранение версий документов RG.RU в Elasticsearch

**Информация для разработчиков**


--------

**Деплой**

Файлы проекта размещены на: `dockerweb.rgwork.ru:/home/gitupdater/version-store-prod`



Требования к системе
-------



* **Минимум 4 ГБ RAM выделено для Docker**

    Для работы Elasticsearch требуется как минимум 2 ГБ оперативной памяти.

    Для Mac объем оперативной памяти, выделенной для Docker, можно установить с помощью пользовательского интерфейса

* **Лимит на mmap должен быть больше или равен 262,144**

    Это самая частая причина, по которой Elasticsearch не запускается с момента выпуска Elasticsearch версии 5.

    В Linux используйте `sysctl vm.max_map_count` на хосте, чтобы просмотреть текущее значение. Обратите внимание, что ограничения должны быть изменены на хосте; они не могут быть изменены из контейнера.

    Если вы используете Docker для Mac, вам потребуется запустить контейнер с переменной среды `MAX_MAP_COUNT`, установленной как минимум в 262144 (с использованием, например, опции `-e` докера), чтобы Elasticsearch установил ограничения на число `mmap` в время запуска.


Виртуальная память
------------------

Elasticsearch по умолчанию использует директорию `hybrid mmapfs / niofs` для хранения своих индексов. По умолчанию ограничения  `mmap` слишком малы, что может привести к нехватке памяти.

В Linux вы можете увеличить ограничения, выполнив следующую команду от имени root:

    sysctl -w vm.max_map_count=262144

Чтобы установить это значение навсегда, обновите параметр `vm.max_map_count` в `/etc/sysctl.conf`. Для проверки после перезагрузки, запустите 

    sysctl vm.max_map_count

Пакеты RPM и Debian настроят этот параметр автоматически. Никаких дополнительных настроек не требуется.



<br><br><br>

--------------------------

Формат времени
-------------


Формат даты в golang приложениях лучше выбирать таким какой 
Эластик понимает по умолчанию, или для совместимоси с программами 
на Javascript указывать число миллисекунд с начала эпохи.
 
```go
// Java формат штампа даты времени Эластик.
timeFormat := "2006-01-02T15:04:05.999Z"
```


<br><br><br>

--------------------------

Порядок работы
==============

Обучная последовательность действий раз0работчика включает
следующие этапы

1. Изменить код
2. Если менялся код Go, перегенерировать бинарник для Linux `sh/build-linux-binary.sh`
3. Запустить докер с Эластик `sh/up.sh`
4. Оттестировать
5. Запушить `sh/push.sh`
6. Отдеплоить `sh/deploy.sh`
   
(optional) Для удобства работы с Эластик можете выполнить команду 
запускающую Кибану и Cerebro.
```
docker-compose -f docker-compose-dev.yml
```



Команды
-------
В директории `sh/` находятся следующие команды.


|   |   |
|---|---|
Запуск  docker-compose.yml                  | `sh/up.sh`
Полный останов                              | `sh/down.sh`
Печать пригласительного сообщения           | `sh/greetings.sh`
Приостановка контейнера                     | `sh/stop.sh`
Старт приостановленного контейнера          | `sh/start.sh`
Генерация исполняемого бинарника для Linux  | `sh/build-linux-binary.sh`
Подготовка директории deploy                | `sh/build-deploy-directory.sh`
Пуш                                         | `sh/push.sh`
Деплой                                      | `sh/deploy.sh`





Инициализация базы данных
-------------------


Директория `elastic_migrations/` содержит файлы для инициализации индекса
doc_versions, предназначенного для хранения версий документов.

Следующие команды выполняются после того, как Эластик стартовал 
на хосте где запущен докер.
Во время  разработки это будет ваша локальная машина, 
после размещения  -  боевой сервер.

Чтобы удалить базу данных версий Документов выполните следующую команду.
```
docker exec version-store-es01  bash -c 'cd /migrations;./delete_index.sh'
```
**Внимание!** На боевом сервере выполняйте команду осознанно.
Команда удалит все сохраненные версии документов. Возможно имеет смысл
предварительно сделать дамп индекса. 

Чтобы породить новую базу данных и наполнить её тестовыми данными выполните следующую команду
```
docker exec version-store-es01  bash -c 'cd /migrations;./init_index.sh'
```

Чтобы убедиться что тестовые данные порожденны нормально на локальном
компьютере в браузере откройте, 

<http://localhost:9000/#/overview?host=http:%2F%2Fversion-store-es01:9200>

команда сработает если запущен Cerebro с помощью docker-compose-dev.

Для просмотра тестовых данных можно воспользоваться плугином Chrome, Head.


Дополнительные команды
------

Проксирующий сервер Caddy используется для добавления CORS заголовков
`Access-Control-Allow-Headers Content-Type` к ответам Эластик. 
(Возможно эти заголовки следует добавить в auth-proxy.)




**Перезапуск Caddy** если изменился configs/Caddyfile 
 
```
dc restart version-store-caddy  
```
**Перестройка контейнера Caddy** если что то изменилость в docker-compose
```
dc up -d --build version-store-caddy     
```